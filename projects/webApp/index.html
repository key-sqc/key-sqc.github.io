<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>去中心化即时通讯</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>去中心化即时通讯</h1>
            <p>点对点加密聊天 · 无需服务器</p>
        </div>
        
        <!-- 使用说明面板 -->
        <div class="instructions-panel" id="instructionsPanel">
            <h3>📱 使用说明</h3>
            <div class="steps">
                <div class="step">
                    <span class="step-number">1</span>
                    <span class="step-text">一方点击"创建房间"生成二维码</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-text">另一方点击"加入房间"扫描二维码</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-text">连接成功后即可开始私密聊天</span>
                </div>
            </div>
            <button id="startBtn" class="start-button">开始使用</button>
        </div>
        
        <div class="connection-panel" id="connectionPanel" style="display: none;">
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">等待连接...</span>
            </div>
            
            <!-- 详细状态信息 -->
            <div class="status-details" id="statusDetails">
                <div class="status-item">
                    <span class="status-label">连接状态:</span>
                    <span class="status-value" id="webrtcStatus">未连接</span>
                </div>
                <div class="status-item">
                    <span class="status-label">房间号:</span>
                    <span class="status-value" id="roomCode">-</span>
                </div>
            </div>
            
            <div class="connection-actions">
                <button id="createBtn" class="action-btn primary">创建房间</button>
                <button id="connectBtn" class="action-btn secondary">加入房间</button>
                <button id="disconnectBtn" class="action-btn danger" style="display: none;">断开连接</button>
            </div>
            
            <!-- 二维码显示面板 -->
            <div class="qr-panel" id="qrPanel" style="display: none;">
                <div class="qr-header">
                    <h4>📱 扫描二维码加入</h4>
                    <p>请对方扫描此二维码</p>
                </div>
                <div class="qr-code-container">
                    <canvas id="qrCanvas"></canvas>
                </div>
                <div class="manual-code">
                    <p>或手动输入代码：</p>
                    <div class="code-display" id="manualCodeDisplay"></div>
                </div>
                <div class="qr-actions">
                    <button id="copyCodeBtn" class="action-btn secondary">复制代码</button>
                    <button id="refreshQRBtn" class="action-btn primary">刷新二维码</button>
                    <button id="closeQRBtn" class="action-btn danger">关闭</button>
                </div>
            </div>
            
            <!-- 加入房间面板 -->
            <div class="join-panel" id="joinPanel" style="display: none;">
                <div class="join-header">
                    <h4>🔗 加入房间</h4>
                    <p>选择加入方式</p>
                </div>
                <div class="join-options">
                    <button id="scanQRBtn" class="join-option-btn">
                        <span class="option-icon">📷</span>
                        <span class="option-text">扫描二维码</span>
                    </button>
                    <button id="manualInputBtn" class="join-option-btn">
                        <span class="option-icon">⌨️</span>
                        <span class="option-text">手动输入代码</span>
                    </button>
                </div>
                <div class="join-actions">
                    <button id="cancelJoinBtn" class="action-btn secondary">取消</button>
                </div>
            </div>
            
            <!-- 手动输入面板 -->
            <div class="manual-input-panel" id="manualInputPanel" style="display: none;">
                <div class="manual-header">
                    <h4>⌨️ 输入连接代码</h4>
                    <p>请输入对方提供的连接代码</p>
                </div>
                <div class="input-container">
                    <textarea id="connectionInput" placeholder="粘贴连接代码..." rows="4"></textarea>
                    <div class="input-hint">请粘贴完整的连接代码</div>
                </div>
                <div class="manual-actions">
                    <button id="confirmManualBtn" class="action-btn primary">确认加入</button>
                    <button id="backToJoinBtn" class="action-btn secondary">返回</button>
                </div>
            </div>
            
            <!-- 二维码扫描面板 -->
            <div class="scan-panel" id="scanPanel" style="display: none;">
                <div class="scan-header">
                    <h4>📷 扫描二维码</h4>
                    <p>对准对方设备的二维码</p>
                </div>
                <div class="scanner-container">
                    <video id="scannerVideo" playsinline></video>
                    <canvas id="scannerCanvas" style="display: none;"></canvas>
                    <div class="scan-frame"></div>
                </div>
                <div class="scan-actions">
                    <button id="cancelScanBtn" class="action-btn secondary">取消扫描</button>
                    <button id="switchCameraBtn" class="action-btn secondary">切换摄像头</button>
                </div>
            </div>
            
            <!-- 连接日志 -->
            <div class="connection-log" id="connectionLog">
                <div class="log-header">
                    <span>连接日志</span>
                    <button id="clearLogBtn" class="clear-log-btn">清空</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-entry">
                        <span class="log-time">[系统]</span>
                        <span class="log-info">欢迎使用去中心化聊天</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <span>私密聊天</span>
                <span class="connection-info">已连接</span>
            </div>
            <div class="messages" id="messages">
                <div class="message received">
                    <div class="message-text">连接已建立！现在可以开始私密聊天了。</div>
                    <div class="message-time">系统消息</div>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="输入消息..." disabled>
                <button class="send-btn" id="sendBtn" disabled>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 简单的QR码生成库 -->
    <script>
        // 简化的QR码生成器
        class SimpleQRCode {
            static generate(text, canvas, size = 200) {
                const ctx = canvas.getContext('2d');
                canvas.width = size;
                canvas.height = size;
                
                // 清空画布
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, size, size);
                
                // 简单的QR码模式 - 使用数据URL编码
                const encodedText = btoa(encodeURIComponent(text));
                this.drawPattern(ctx, encodedText, size);
            }
            
            static drawPattern(ctx, data, size) {
                const moduleSize = 4;
                const padding = 10;
                
                ctx.fillStyle = 'black';
                
                // 绘制定位图案
                this.drawFinderPattern(ctx, padding, padding, moduleSize);
                this.drawFinderPattern(ctx, size - padding - 7 * moduleSize, padding, moduleSize);
                this.drawFinderPattern(ctx, padding, size - padding - 7 * moduleSize, moduleSize);
                
                // 简单数据编码
                let x = padding + 9 * moduleSize;
                let y = padding + 9 * moduleSize;
                
                for (let i = 0; i < data.length; i++) {
                    const charCode = data.charCodeAt(i);
                    for (let bit = 0; bit < 8; bit++) {
                        if (charCode & (1 << bit)) {
                            ctx.fillRect(x, y, moduleSize, moduleSize);
                        }
                        x += moduleSize;
                        if (x >= size - padding - moduleSize) {
                            x = padding + 9 * moduleSize;
                            y += moduleSize;
                        }
                    }
                }
            }
            
            static drawFinderPattern(ctx, x, y, moduleSize) {
                ctx.fillStyle = 'black';
                ctx.fillRect(x, y, 7 * moduleSize, 7 * moduleSize);
                ctx.fillStyle = 'white';
                ctx.fillRect(x + moduleSize, y + moduleSize, 5 * moduleSize, 5 * moduleSize);
                ctx.fillStyle = 'black';
                ctx.fillRect(x + 2 * moduleSize, y + 2 * moduleSize, 3 * moduleSize, 3 * moduleSize);
            }
        }
    </script>

    <script src="app.js"></script>
</body>
</html>